<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title></title>	<link href="/media/css/basis.css" media="screen" rel="stylesheet" type="text/css" />		<!-- <style type="text/css">
		
		body{margin:0px;padding:0px;border:0px; font-family: verdana; }
		/*div{border:1px solid gray;}*/
		/* div#bdp-div-page{width:820px;margin:auto; } */
		div#bdp-div-header{background-color: lightblue;widdth:808px; height: 100px; padding-left:10px;}
		div#bdp-div-main{ }
		div#bdp-div-left-box{float:left; padding-left:10px; background-color: silver;width: 00px; height: 300px;}
		div#bdp-div-content{ padding-left: 50px; padding-right:10px;
background-color: white; }
		div#bdp-div-right-box{ float:top; background-color: red;
				position:absolute;leftX:710px;top:124px;			
				width: 159	px; heighXt: 300px;
				}
		div#bdp-div-footer{ clear:both;background-color: lightblue;width: 100%; height: 20px;}
		div#some-relative-div{background-color:red; 
						position: relative;left:100px;top:30px;
						border-style:solid;
						border-width:1px;
						border-color:black;
						width:100px;
						}
	</style>*/ -->	
	<!--  No google code yet
	<script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAA9KzjVQeNwg9PxP5W9KU97RQq67XTNzbzZjqno17fliVJumdGxxTFxepvDBc9pv6X7MuYsNwoo9OyWg"></script>
	 -->	
	
  <script src="/media/request.js" type="text/javascript"></script>
 	<!-- <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.5/dojo/dojo.xd.js" type="text/javascript">
		dojo.require("dijit.dijit");
		dojo.require("dojox.grid.DataGrid");
		dojo.require("dojox.grid.EnhancedGrid");
		dojo.require("dojo.data.ItemFileWriteStore");
		dojo.require("dojox.data.QueryReadStore");
		dojo.require("dojo.parser"); 	
 	</script>  -->
	
<!-- 
	<script type="text/javascript" src="/js/dojo/dojo.js">
		//dojo.require("dijit.dijit");
		dojo.require("dojox.grid.DataGrid");
		//dojo.require("dojox.grid.EnhancedGrid");
		//dojo.require("dojo.data.ItemFileWriteStore");
		dojo.require("dojox.data.QueryReadStore");
		//dojo.require("dojo.parser");
	</script>
	  -->
</head>

<body class="tundra">
<script type="text/javascript"> 
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18079131-1']);
  _gaq.push(['_trackPageview']);
 
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })(); 
</script><div id='bdp-div-page'>
<!-- Header header start -->
<div id='bdp-div-header' >
	<font size=18>
		<a style='text-decoration: none; color: navy; font-weight:bold;' href='http://bildelspriser.dk'
			title="bildelspriser vejen til de billigste reservedele til bilen - billige reservedele " >
		bildelspriser.dk </a> &nbsp;  &nbsp;  &nbsp;  &nbsp; <a style='text-decoration: none; color: silver; font-weight:bold;' href="/index/beta">BETA</a>
	</font>
	<a style='text-decoration: none; color: navy' href='http://bildelspriser.dk'
			title="bildelspriser vejen til de billigste reservedele til bilen - billige reservedele " >
	 <br/>- vejen til de billigste dele til bilen
	 </a>
</div >
<div id='bdp-div-navigation' >
	<div id="bdp-span-nav-bar" ><span id="bdp-span-nav-item"  class="active"><a href="/">Find</a></span>
 | <span id="bdp-span-nav-item" ><a href="/index/beta">Beta</a></span>
 | <span id="bdp-span-nav-item" ><a href="/index/brands">Bilfabrikater</a></span>
</span></div >  
<!-- Header header end -->
<!-- removed for now 
<div>div
<form>form
	<input/>
</form>
</div>
 -->
<!--  Main area start -->
<div id='bdp-div-main'>
	<!-- Left Box is hidden until we have somthing valuabele to put into it. 
	<div id='bdp-div-left-box'>
		Left Box
	</div>
	 -->
	<!--  Dbox hidden until we have some one that wants to pay
	<div id='bdp-div-right-box'>
		D-Box
	</div>
	 -->
	<div id='bdp-div-content'>
		<script type="text/javascript" language="JavaScript" >
var autocompleter_car_models;
var autocompleter_car_makes;
var js_fs1_car_model;
var js_fs1_car_make;
var selected_car_make_id;
var selected_car_make_name;
var selected_car_model_id;
var selected_car_model_name;
var results_store
var current_ds_url;
var tableGrid;
var tableGridState = "uninitialized";
var pending_ds_url;
var targetSelect;
var btn_find;
var div_bdp_results;
var init_state=0;

var target_select_event = function(){
	alert ("dyn func");	
}

function error(message){
	myInfo("Error " + message);	
}

function getQ(){
	var txt = document.getElementById('tx_free_text_search');
	if(txt){
		return txt.value;
	}
	else{
		error("Unable to fetch 'tx_free_text_search' ");
	}	
}

function getBtnFind(){
	if(!(btn_find))
		btn_find = document.forms['HtmlSearch'].elements['btn_find'];
	if(btn_find)
		return btn_find;
	else
		error("could not find btn_find button() ");	
}

function setResultsDivText(text){
	var msg = "null";
	if(text)
		msg = text;
	var d  = getResultsDiv();
	d.innerHTML = msg ;
}


function getResultsDiv(){
	var div = document.getElementById('divbdpresults');
	if(div && div.nodeName=="DIV"){
		return div;
	}
	else{
		error("Unable to fetch 'div-bdp-results' ");
	}	
}

function get_selected_model(){
	var model_select = document.forms['HtmlSearch'].elements['model_select'];
	selected_car_model_id = model_select.value;
	if(selected_car_model_id)
		if(selected_car_model_id > 0)
			return selected_car_model_id;
		else
			error("Selected car model was lesss than 0 "+selected_car_model_id);
	else
		error("Selected car model was undefined");
}

function update_results(xmlreply, modelSelect) {
	div_bdp_results = getResultsDiv();
	myInfo("in_update_results");
	if (xmlreply.status == Http.Status.OK) {
		if(div_bdp_results){
			setResultsDivText("<h2>Søgeresultater med '"+getQ()+"'</h2>" + xmlreply.responseText);
		}
		else
			error("div_bdp_results was not set?");
	} else {
		alert('Cannot handle the AJAX call. - update_results');
	}
}

function update_div(url){
	if(!(div_bdp_results)){
		alert("div-bdp-results div not found");
		return;
	}
	myInfo("update-div-"+url);
}

function btn_find_onclick(){
	setResultsDivText("Søgning efter priser..");
	//getBtnFind().disabled = true;
	var targetSelect = document.forms['HtmlSearch'].elements['model_select'];
	var q = '/q/'+getQ();		
	if(targetSelect == null){
		alert("Target select was null");
	}
	var selectedVal = get_selected_model();
	if (selectedVal != '') {
		var w_url = '/index/newsearch/car_model_id/' + selectedVal + q;
		myInfo("Url was " +w_url)
		Http.get({
			url: w_url ,
			callback: update_results,
			cache: Http.Cache.Get
		}, [targetSelect]);
	} else {
		targetSelect.disabled = true;
		error("Ajax error");
		//document.forms['HtmlSearch'].elements['submodel'].style.display = 'none';
	}	
}


function body_on_load(){
	if(init_state>2){
		return; // already run.
	}
   init_state=1;	
   targetSelect = document.forms['HtmlSearch'].elements['model_select'];
   btn_find = document.forms['HtmlSearch'].elements['btn_find'];
   div_bdp_results = getResultsDiv();
   init_state++;
   btn_find.onclick = function(){
		btn_find_onclick();
	}; 

		   
	targetSelect.onfocus=function(){
		//	alert("huhej - focus");	
	};
	init_state++;
}

document.body.onload = body_on_load;

function handleBrandChange(dropdown) {
	var targetSelect = document.forms['HtmlSearch'].elements['model_select'];
	if(targetSelect == null){
		alert("Target select was null");
		return;
	}
	var selectedVal = dropdown[dropdown.selectedIndex].value;
	if(init_state==0){
		myInfo("Init state was 0 ");
		dropdown[dropdown.selectedIndex].value = selectedVal;
		body_on_load();
	}
	if(init_state==0){
		error("Init state was 0 after second try");
	}
	myInfo("Selected val was "+selectedVal);
	if (selectedVal != '') {
		targetSelect.disabled = true;
		// for submodels  // document.forms['HtmlSearch'].elements['submodel'].style.display = 'none';
		Http.get({
//			url: '/ajax.php?op=brandChange&bid=' + selectedVal,
			url: '/index/autocompletecarmodels/car_make_id/' + selectedVal,
			callback: fillModelSelect,
			cache: Http.Cache.Get
		}, [targetSelect]);
	} else {
		targetSelect.disabled = true;
		alert("Ajax error - handleBrandChange");

	}
	/*alert('a');*/	
	//targetSelect.focus();
	/*alert('b');*/
}

function fillModelSelect(xmlreply, modelSelect) {
	if (xmlreply.status == Http.Status.OK) {
		var xmlDoc = xmlreply.responseXML;
		var JSON_text = xmlreply.responseText;
		var myObject = eval('(' + JSON_text + ')');
		// JSON Inspiration - http://www.json.org/js.html
		if(myObject == null){
			alert("JSON parsing did not work");
		}
		items = myObject.items;
		if (items.length > 0) {
			modelSelect.options.length = 0;
			modelSelect.length = items.length+1;
			modelSelect[0].text = 'Alle modeller';
			modelSelect.disabled = false;
			var item;
			for (i = 0; i < items.length; i++) {
				item = items[i];
				modelSelect.length++;
				modelSelect[i+1].value = item.id;
				modelSelect[i+1].text = item.name;
			}
		} else {
			document.body.innerHTML +="<br/>Child Nodes was null " + JSON_text;
			modelSelect.disabled = true;
			modelSelect.length = 1;
			modelSelect[0].text = '-Vælg først mærke';
		}
	} else {
		alert('Cannot handle the AJAX call.');
	}
}


function getFuncName(f){
    var s= f.tostring().match(/function (\w*)/)[1];
    if((s==null) || (s.length == 0)) return "anonumous()";
    return s+"()";
}

function getStackTrace(seperator){
    if(!seperator)
        seperator = "-";
    var s="";
    for(var a = arguments.caller;a != null; a = a.caller){
        console.log("In loop");
        s += getFuncName(a.callee) + seperator;
    }
    return s;
}

function myInfo(s){
	//document.body.innerHTML += "<br/>"+s;
	//d = getResultsDiv();
	//d.innerHTML =  s;
}
var setQandRun = function(new_q){
	//var new_q = link.value;
	var q_field = document.getElementById('tx_free_text_search');
	if(q_field){
		q_field.value = new_q;
	}	
	btn_find_onclick();
}

function fs1_car_make_changed(){
        myInfo("start");
	//alert("Inside fs1_car_make_changed ?  ");
	var new_car_make_id = dijit.byId('fs1_car_make').value;
	if(new_car_make_id != selected_car_make_id){
		// Time to delete the content of some vars
		selected_car_make_name = "";
		selected_car_model_id = "";
		selected_car_model_name ="";
		console.log("car_make_id changed from " + selected_car_make_id + " to " + new_car_make_id );
	}
	else{
		console.log("?? car_make_id DID NOT change from "  + selected_car_make_id  + " to " + new_car_make_id);
	}
	selected_car_make_id = new_car_make_id;
	try{
		set_car_model_id(selected_car_make_id);
	}
	catch(err){
		alert('some error');
	}
        myInfo("end");
}

function fs1_car_model_changed(){
    var new_car_model_id = dijit.byId('fs1_car_model').value;
    if(new_car_model_id != selected_car_model_id){
         console.log("car_model_id changed from " + selected_car_model_id + " to " + new_car_model_id);
         selected_car_model_id = new_car_model_id;
    }
}

function set_car_model_id(car_make_id){
	if(car_make_id == ""){
		alert("No car make defined");
		dijit.byId("fs1_car_model").attr({disabled:true});
		return;
		}
	dijit.byId("fs1_car_model").attr({disabled:false});

	var new_url = "/index/autocompletecarmodels/car_make_id/"+car_make_id;
        autocompleter_car_models = new custom.AutocompleteReadStore({
            url:	new_url
            ,requestMethod: "get"
        });

        if(!fs1_car_model){
            fs1_car_model = dijit.byId("fs1_car_model");
            console.log("Needed to find the 'fs1_car_model' by ID? ");
            if(!fs1_car_model){
                console.error("Unable to find the fs1_car_model");
                alert("Unable to find the fs1_car_model");
            }
            fs1_car_model.value = ""; // reset the value, since we changed the car_make
        }
	fs1_car_model.attr({     store: autocompleter_car_models      });

        /*if(!tx_free_text_search){
            console.log("Needed to find the "tx_free_text_search" by ID? ");
            tx_free_text_search = dijit.byId("tx_free_text_search");
            if(!tx_free_text_search){
                alert("Unable to find the tx_free_text_search control?");
            }
        }
	var q = tx_free_text_search.Value;	*/
	//update_iframe(q,car_model_id);
	//dijit.byId("resultsStore").refresh();
}

function update_iframe(name, car_model_id){
        console.log("Update_iframe  " + name + "," + car_model_id);
//alert("name: " + name + "\ncar_model_id:" + car_model_id);
//	dijit.byId("tx_free_text_search").src = "about:error";
	var  newurl = "/index/datasearchresults"
        if(!car_model_id && selected_car_model_id > 0){
            car_model_id = selected_car_model_id;
            console.log("setting car_model_id from selected " + car_model_id);
        }
        if(car_model_id){
		newurl += "/car_model_id/" + car_model_id ;
	}
        else
            { console.log(" car_model_id was empty ?? ");
            }
	if(name && name != "Skriv hvad du mangler" ){
		newurl += "/q/" + name;
	}
        else
            { console.log(" name was empty ?? ");}	//alert("new url " + newurl);
        if(!tableGrid)
            tableGrid = dijit.byId("tableGrid");
        if(!tableGrid)
            alert("Could not find tableGrid?");
        //tg.store.url = newurl;
        //
       // var new_store = new dojox.data.QueryReadStore({  url: newurl , query: {id:'*'}, method : get    });
       //var new_store = new dojox.data.QueryReadStore({  url: newurl });
       // var new_store = new dojo.data.ItemFileReadStore({  url: newurl    });
        //new_store.fetch();
        //var i = new_store.getItems();
        //var new_store = getDataSearchJson(car_model_id,q);
       // infoField = dojo.byId("InfoField");
       if(current_ds_url == newurl){
            console.log("The Url was already set to '"+newurl+"' - so I will not ask for it again");
            return;
       }
       if( tableGridState == "creatingReadstore"){
            pending_ds_url = newurl;
            console.log("The tableGridState was " +tableGridState+ "  - no start & pending_ds_url =  " + pending_ds_url);
            return;

       }
       current_ds_url = newurl;
    console.log("New url is "+newurl);
        tableGridState = "creatingReadstore";
    var new_store = new dojo.data.ItemFileReadStore({ url: newurl });
    console.log("DataStore updated");
            new_store.fetch({
                query: { id: '*' }
        }); // ends fetch call.
        try { tableGrid.setStore(new_store);
            console.log("Store set on the grid"); }
        catch(e)
        {
            console.log("Error while setting the store to the grid");
            console.log("Error when setting" + e);
        }
        if(pending_ds_url){
            console.log("There was a pending ds url, lets run the event handler again");
            pending_ds_url = null;
            btn_submitButton();
        }
        tableGridState = "complete";
}




/*
 * 
 var UpdateItemWriteStore = function(){
        jsonStore.fetch({
                query: { id: '*' }
        }); // ends fetch call.
} // ends function
*/
</script>
<div  class="tundra">
<form id="HtmlSearch" enctype="application/x-www-form-urlencoded" accept-charset="utf-8" action="" method="post"><dl class="zend_form">
<dt id="make_select-label"><label for="make_select" class="optional">Mærke</label></dt>
<dd id="sel-element">
<select name="make_select" id="make_select" style="width: 170px" onchange="handleBrandChange(this);">
    <option value="0" label="Vælg mærke">Vælg mærke</option>
    <option value="14" label="AL-KO">AL-KO</option>
    <option value="13" label="Alfa Romeo">Alfa Romeo</option>
    <option value="1" label="AUDI">AUDI</option>
    <option value="2" label="BMW">BMW</option>
    <option value="3" label="CITROEN">CITROEN</option>
    <option value="24" label="DAEWOO">DAEWOO</option>
    <option value="31" label="DAIHATSU">DAIHATSU</option>
    <option value="16" label="FIAT">FIAT</option>
    <option value="4" label="FORD">FORD</option>
    <option value="5" label="HONDA">HONDA</option>
    <option value="6" label="HYUNDAI">HYUNDAI</option>
    <option value="20" label="IVECO">IVECO</option>
    <option value="15" label="KIA">KIA</option>
    <option value="17" label="LANCIA">LANCIA</option>
    <option value="18" label="LANDROVER">LANDROVER</option>
    <option value="11" label="MAZDA">MAZDA</option>
    <option value="19" label="MERCEDES">MERCEDES</option>
    <option value="23" label="MITSUBISHI">MITSUBISHI</option>
    <option value="12" label="NISSAN">NISSAN</option>
    <option value="10" label="OPEL">OPEL</option>
    <option value="25" label="PEUGEOT">PEUGEOT</option>
    <option value="29" label="RENAULT">RENAULT</option>
    <option value="21" label="ROVER">ROVER</option>
    <option value="27" label="SEAT">SEAT</option>
    <option value="28" label="SKODA">SKODA</option>
    <option value="30" label="SUBARU">SUBARU</option>
    <option value="22" label="SUZUKI">SUZUKI</option>
    <option value="8" label="SAAB">SAAB</option>
    <option value="9" label="TOYOTA">TOYOTA</option>
    <option value="26" label="VOLVO">VOLVO</option>
    <option value="7" label="VW">VW</option>
</select></dd>
<dt id="model_select-label"><label for="model_select" class="optional">Model</label></dt>
<dd id="model-element">
<select name="model_select" id="model_select" style="width: 170px" disabled="true">
    
</select></dd>
<dt id="tx_free_text_search-label"><label for="tx_free_text_search" class="optional">Varenavn - fritekst - fx &quot;skive&quot;</label></dt>
<dd id="tx_free_text_search-element">
<input type="text" name="tx_free_text_search" id="tx_free_text_search" value="" trim="1" style="width:170px" /></dd>
<dt id="btn_find-label">&#160;</dt><dd id="btn_find-element">
<button name="btn_find" id="btn_find" type="button">Find</button></dd></dl></form><!-- <div id="div-debug-info" style="width: 100%; height: 100px;"></>info</div>  -->
<!--span dojoType="dojox.data.QueryReadStore" id="myStore"
   jsId="myStore" url="/index/datasearchresults/"  query="{id: '*'}"  requestMethod="get">
</span-->
<div id="divbdpresults" name="divbdpresults" ></div>



</div>				
	</div>


</div>
<!--  Main area start -->
<div id='bdp-div-footer'>
<center>bildelspriser.dk</center>
</div>
</div>
</body>
</html>
